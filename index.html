<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©)</title>
    <script async defer src="https://accounts.google.com/gsi/client" onload="onGsiLoad()"></script>
    
    <style>
        :root {
            --primary: #0f766e;
            --secondary: #0d9488;
            --drive: #1a73e8;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #334155;
            --border: #e2e8f0;
            /* ‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
            --status-normal: #10b981;
            --status-mild: #f59e0b;
            --status-mod: #f97316;
            --status-severe: #ef4444;
            --status-pdr: #b91c1c;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 1100px;
            background: var(--card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; color: var(--primary); margin-bottom: 5px; }
        .subtitle { text-align: center; color: #64748b; margin-bottom: 30px; }
        
        .api-setup {
            background-color: #fef2f2;
            border: 1px solid #fca5a5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .api-setup input, .api-setup select {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .load-model-btn {
            margin-top: 10px;
            background-color: #475569;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

        .upload-area {
            border: 2px dashed #94a3b8;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            background-color: #f1f5f9;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .folder-input-group {
            display: flex;
            width: 100%;
            max-width: 600px;
            gap: 10px;
            margin-top: 10px;
        }
        .folder-input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-weight: bold;
            color: #1e3a8a;
        }
        .drive-btn {
            background-color: white;
            color: var(--drive);
            border: 2px solid var(--drive);
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        .drive-btn:hover { background-color: #f0f4f9; }

        .patient-record {
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 25px;
            margin-top: 25px;
            background: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .patient-header h3 { margin: 0; color: var(--primary); font-size: 18px; }
        .patient-img-preview {
            max-width: 250px;
            max-height: 250px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: block;
            margin: 0 auto 20px auto;
        }
        
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .eye-card { border: 1px solid var(--border); border-radius: 8px; padding: 20px; background: #fafaf9; }
        .eye-card h4 { margin-top: 0; display: flex; justify-content: space-between; align-items: center; font-size: 17px; color: #475569; border-bottom: 1px solid var(--border); padding-bottom: 10px;}
        .severity-badge { padding: 5px 12px; border-radius: 20px; color: white; font-size: 13px; font-weight: bold; }
        
        .detailed-report { margin-top: 15px; font-size: 14px; line-height: 1.6; }
        .detailed-report strong { color: #1e293b; }
        .detailed-report ul { margin: 8px 0; padding-left: 20px; }
        
        .csme-box { background-color: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 10px; border-radius: 6px; margin-top: 10px; font-weight: bold; font-size: 13px; text-align: center; }
        .treatment-box { margin-top: 15px; padding: 12px; border-radius: 6px; font-weight: bold; font-size: 14px; border: 1px solid #cbd5e1; }

        .loading-box { display: none; text-align: center; padding: 20px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; margin-top: 20px; color: #1e3a8a; font-weight: bold; }

        @media (max-width: 850px) { .results-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>ü©∫ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h1>
        <div class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Google Drive (‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©)</div>

        <div class="api-setup">
            <strong>üîë 1. ‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á Gemini:</strong>
            <input type="password" id="api-key" placeholder="‡∏ß‡∏≤‡∏á Google Gemini API Key ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
            
            <button class="load-model-btn" onclick="fetchModels()">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ AI Model ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö</button>
            
            <div id="model-selector-container" style="display: none; margin-top: 15px;">
                <strong>ü§ñ 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å AI Model:</strong>
                <select id="model-select"></select>
            </div>
            <div id="api-status" style="margin-top: 10px; font-size: 14px; font-weight: bold;"></div>
        </div>

        <div class="upload-area">
            <p style="margin-bottom: 0; color: #1a73e8; font-weight: bold;">üìÅ ‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å)</p>
            <div class="folder-input-group">
                <input type="text" id="folder-id" value="1-WV_s3s7mLKDUfs7fl-UwH0H4TxxO1cx" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive">
                <button class="drive-btn" onclick="authAndFetchFolder()">
                    <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#FFC107" d="M17 6l11 19-11 19L6 25z"/><path fill="#1976D2" d="M17 44h22L28 25z"/><path fill="#4CAF50" d="M39 6H17l11 19z"/></svg>
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå
                </button>
            </div>
            <p style="font-size: 12px; color: #64748b;">(‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</p>
        </div>

        <div id="main-status" class="loading-box"></div>
        <div id="error-box" style="color: red; text-align: center; margin-top:10px; font-weight: bold;"></div>

        <div id="master-results-container"></div>
    </div>

    <script>
        const GOOGLE_CLIENT_ID = '446093303322-5sksg8sflshmq9df4d9f72nnt3v9gcv6.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
        
        let tokenClient;
        let accessToken = null;

        function onGsiLoad() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    fetchFilesInFolder();
                },
            });
        }

        function authAndFetchFolder() {
            if (!document.getElementById('folder-id').value.trim()) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Folder ID'); return; }
            if (!document.getElementById('api-key').value.trim() || !document.getElementById('model-select').value) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î AI Model ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); return; }
            if (!accessToken) tokenClient.requestAccessToken();
            else fetchFilesInFolder();
        }

        async function fetchFilesInFolder() {
            const folderId = document.getElementById('folder-id').value.trim();
            const statusBox = document.getElementById('main-status');
            const container = document.getElementById('master-results-container');
            
            container.innerHTML = ""; 
            statusBox.style.display = 'block';
            statusBox.style.backgroundColor = '#eff6ff'; statusBox.style.color = '#1e3a8a';
            statusBox.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û... ‚è≥";

            try {
                const query = `'${folderId}' in parents and (mimeType='image/jpeg' or mimeType='image/png' or mimeType='application/pdf') and trashed=false`;
                const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,mimeType)`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                
                if (!data.files || data.files.length === 0) {
                    statusBox.innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö"; return;
                }

                statusBox.innerText = `‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå ${data.files.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£... ü§ñü©∫`;
                
                for (let i = 0; i < data.files.length; i++) {
                    await processDriveFile(data.files[i], i + 1, data.files.length);
                }
                
                statusBox.innerText = "‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß";
                statusBox.style.backgroundColor = "#dcfce7"; statusBox.style.color = "#16a34a";
            } catch (error) {
                statusBox.style.display = 'none';
                document.getElementById('error-box').innerText = `‚ùå Error: ${error.message}`;
            }
        }

        async function processDriveFile(fileMeta, currentIndex, totalFiles) {
            const container = document.getElementById('master-results-container');
            const fileId = fileMeta.id;
            
            const recordDiv = document.createElement('div');
            recordDiv.className = 'patient-record';
            recordDiv.innerHTML = `
                <div class="patient-header">
                    <h3>üìÑ [${currentIndex}/${totalFiles}] : ${fileMeta.name}</h3>
                    <span id="status-${fileId}" style="color: #2563eb; font-weight: bold;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î... ü§ñ</span>
                </div>
                <img id="img-${fileId}" class="patient-img-preview" style="display:none;">
                <div id="results-${fileId}" class="results-grid" style="display:none;"></div>
            `;
            container.appendChild(recordDiv);

            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const blob = await response.blob();
                
                const imgEl = document.getElementById(`img-${fileId}`);
                if (fileMeta.mimeType !== 'application/pdf') {
                    imgEl.src = URL.createObjectURL(blob);
                    imgEl.style.display = 'block';
                }

                const reader = new FileReader();
                reader.readAsDataURL(blob);
                await new Promise(resolve => reader.onloadend = resolve);
                const base64File = reader.result.split(',')[1];

                await runGeminiDetailedAnalysis(base64File, fileMeta.mimeType, fileId);
            } catch (error) {
                document.getElementById(`status-${fileId}`).innerText = `‚ùå ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: ${error.message}`;
                document.getElementById(`status-${fileId}`).style.color = "red";
            }
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏à‡∏±‡∏Å‡∏©‡∏∏‡πÅ‡∏û‡∏ó‡∏¢‡πå
        async function runGeminiDetailedAnalysis(base64File, mimeType, elementId) {
            const apiKey = document.getElementById('api-key').value.trim();
            const targetModel = document.getElementById('model-select').value;

            // Prompt ‡∏ï‡∏£‡∏ß‡∏à‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏£‡∏≠‡∏¢‡πÇ‡∏£‡∏Ñ, ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á, ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á Macular Edema
            const promptText = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏à‡∏±‡∏Å‡∏©‡∏∏‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤ (Retina Specialist) ‡∏à‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô (Fundus Photography) ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:
            1. ‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö Diabetic Retinopathy (DR) ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (Normal, Mild NPDR, Moderate NPDR, Severe NPDR, ‡∏´‡∏£‡∏∑‡∏≠ PDR)
            2. ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á-‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏¢‡πÇ‡∏£‡∏Ñ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: Microaneurysms (MA), Hemorrhages (Dot/Blot/Flame-shaped), Hard Exudates (HE), Soft Exudates (Cotton Wool Spots), Neovascularization
            3. ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á Clinically Significant Macular Edema (CSME) ‡πÇ‡∏î‡∏¢‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á HE ‡πÉ‡∏Å‡∏•‡πâ‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì Fovea (‡∏à‡∏∏‡∏î‡∏†‡∏≤‡∏û‡∏ä‡∏±‡∏î)
            4. ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (Management Plan) ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ (Refer) ‡∏û‡∏ö‡∏à‡∏±‡∏Å‡∏©‡∏∏‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

            ‡∏ï‡∏≠‡∏ö‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢ (OS) ‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤ (OD) ‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏≠‡∏Å JSON):
            {"left": {"grade": "‡∏£‡∏∞‡∏î‡∏±‡∏ö DR", "color": "‡∏£‡∏´‡∏±‡∏™‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", "detailed_findings": "‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏£‡∏≠‡∏¢‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)", "csme_risk": "‡∏ï‡πà‡∏≥/‡∏Å‡∏•‡∏≤‡∏á/‡∏™‡∏π‡∏á", "plan": "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"}, "right": {"grade": "‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏•", "color": "‡∏£‡∏´‡∏±‡∏™‡∏™‡∏µ", "detailed_findings": "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", "csme_risk": "‡∏£‡∏∞‡∏ö‡∏∏", "plan": "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"}}`;
            
            const payload = { "contents": [{ "parts": [{ "text": promptText }, { "inline_data": { "mime_type": mimeType, "data": base64File } }] }], "generationConfig": { "response_mime_type": "application/json" } };
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${targetModel}:generateContent?key=${apiKey}`, { method: 'POST', body: JSON.stringify(payload) });
            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);

            let resultText = data.candidates[0].content.parts[0].text.replace(/```json/g, "").replace(/```/g, "").trim();
            const aiData = JSON.parse(resultText);
            
            const resultsGrid = document.getElementById(`results-${elementId}`);
            resultsGrid.innerHTML = generateDetailedEyeCardHTML('‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢ (OS)', aiData.left) + generateDetailedEyeCardHTML('‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤ (OD)', aiData.right);
            resultsGrid.style.display = 'grid';
            document.getElementById(`status-${elementId}`).innerText = "‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
            document.getElementById(`status-${elementId}`).style.color = "#16a34a";
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        function generateDetailedEyeCardHTML(title, data) {
            if (!data) return `<div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${title}</div>`;
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≤‡∏°‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            let bgColor, textColor;
            switch(data.color) {
                case '#10b981': bgColor='#dcfce7'; textColor='#166534'; break; // Normal
                case '#f59e0b': bgColor='#fef3c7'; textColor='#92400e'; break; // Mild
                case '#ef4444': bgColor='#fee2e2'; textColor='#991b1b'; break; // Severe/PDR
                default: bgColor='#fff7ed'; textColor='#9a3412'; break; // Moderate
            }

            return `
            <div class="eye-card">
                <h4>üëÅÔ∏è ${title} <span class="severity-badge" style="background-color: ${data.color || '#64748b'};">${data.grade || '-'}</span></h4>
                
                <div class="detailed-report">
                    <strong>üîç ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong>
                    <p style="margin-top:5px; white-space: pre-wrap;">${data.detailed_findings || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≠‡∏¢‡πÇ‡∏£‡∏Ñ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥'}</p>
                </div>

                <div class="csme-box" style="background-color: ${data.csme_risk === '‡∏™‡∏π‡∏á' ? '#fee2e2' : (data.csme_risk === '‡∏Å‡∏•‡∏≤‡∏á' ? '#fff7ed' : '#f0f9ff')}; 
                                         border-color: ${data.csme_risk === '‡∏™‡∏π‡∏á' ? '#fca5a5' : (data.csme_risk === '‡∏Å‡∏•‡∏≤‡∏á' ? '#ffedd5' : '#bae6fd')}; 
                                         color: ${data.csme_risk === '‡∏™‡∏π‡∏á' ? '#991b1b' : (data.csme_risk === '‡∏Å‡∏•‡∏≤‡∏á' ? '#9a3412' : '#0369a1')};">
                    üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á Macular Edema: ${data.csme_risk || '‡∏ï‡πà‡∏≥'}
                </div>

                <div class="treatment-box" style="border: 1px solid ${data.color}; background-color: ${bgColor}; color: ${textColor};">
                    üìã ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${data.plan || '-'}
                </div>
            </div>`;
        }

        async function fetchModels() {
            const apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) return alert("‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            document.getElementById('api-status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠... ‚è≥";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const data = await response.json();
                const validModels = data.models.filter(m => m.name.includes("gemini"));
                const selectBox = document.getElementById('model-select');
                selectBox.innerHTML = "";
                validModels.forEach(m => {
                    const opt = document.createElement("option"); opt.value = m.name; opt.text = m.displayName || m.name;
                    if (m.name.includes("1.5-flash")) opt.selected = true;
                    selectBox.appendChild(opt);
                });
                document.getElementById('model-selector-container').style.display = "block";
                document.getElementById('api-status').innerText = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Gemini ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î!";
                document.getElementById('api-status').style.color = "#16a34a";
            } catch (e) { document.getElementById('api-status').innerText = "‚ùå API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"; document.getElementById('api-status').style.color = "red"; }
        }
    </script>
</body>
</html>
