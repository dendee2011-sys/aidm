<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©)</title>
    <script async defer src="https://accounts.google.com/gsi/client" onload="onGsiLoad()"></script>
    
    <style>
        :root {
            --primary: #0f766e;
            --secondary: #0d9488;
            --drive: #1a73e8;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #334155;
            --border: #e2e8f0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 1100px;
            background: var(--card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; color: var(--primary); margin-bottom: 5px; }
        .subtitle { text-align: center; color: #64748b; margin-bottom: 30px; }
        
        .api-setup {
            background-color: #fef2f2;
            border: 1px solid #fca5a5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .api-setup input, .api-setup select {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .load-model-btn {
            margin-top: 10px;
            background-color: #475569;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

        .upload-area {
            border: 2px dashed #94a3b8;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            background-color: #f1f5f9;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .folder-input-group {
            display: flex;
            width: 100%;
            max-width: 650px;
            gap: 10px;
            margin-top: 10px;
        }
        .folder-input-group input {
            flex: 1;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-weight: bold;
            color: #1e3a8a;
        }
        .drive-btn {
            background-color: white;
            color: var(--drive);
            border: 2px solid var(--drive);
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        .drive-btn:hover { background-color: #f0f4f9; }

        .patient-record {
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 25px;
            margin-top: 25px;
            background: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .patient-header h3 { margin: 0; color: var(--primary); font-size: 18px; }
        .patient-img-preview {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: block;
            margin: 0 auto 20px auto;
        }
        
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .eye-card { border: 1px solid var(--border); border-radius: 8px; padding: 20px; background: #fafaf9; }
        .eye-card h4 { margin-top: 0; display: flex; justify-content: space-between; align-items: center; font-size: 17px; color: #475569; border-bottom: 1px solid var(--border); padding-bottom: 10px;}
        .severity-badge { padding: 5px 12px; border-radius: 20px; color: white; font-size: 13px; font-weight: bold; }
        
        .detailed-report { margin-top: 15px; font-size: 14px; line-height: 1.6; }
        .csme-box { background-color: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 10px; border-radius: 6px; margin-top: 10px; font-weight: bold; font-size: 13px; text-align: center; }
        .treatment-box { margin-top: 15px; padding: 12px; border-radius: 6px; font-weight: bold; font-size: 14px; border: 1px solid #cbd5e1; }

        .retry-btn {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #475569;
            font-weight: bold;
            display: none;
            transition: 0.2s;
        }
        .retry-btn:hover { background: #e2e8f0; }

        .loading-box { display: none; text-align: center; padding: 20px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; margin-top: 20px; color: #1e3a8a; font-weight: bold; }

        @media (max-width: 900px) { .results-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>ü©∫ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h1>
        <div class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©)</div>

        <div class="api-setup">
            <strong>üîë 1. ‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á Gemini:</strong>
            <p style="font-size: 12px; color: #64748b; margin: 5px 0;">(‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ã‡πâ‡∏≥)</p>
            <input type="password" id="api-key" placeholder="‡∏ß‡∏≤‡∏á Google Gemini API Key ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
            
            <button class="load-model-btn" onclick="fetchModels()">üîÑ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î AI Model</button>
            
            <div id="model-selector-container" style="display: none; margin-top: 15px;">
                <strong>ü§ñ 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å AI Model:</strong>
                <select id="model-select"></select>
            </div>
            <div id="api-status" style="margin-top: 10px; font-size: 14px; font-weight: bold;"></div>
        </div>

        <div class="upload-area">
            <p style="margin-bottom: 0; color: #1a73e8; font-weight: bold;">üìÅ ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive</p>
            <div class="folder-input-group">
                <input type="text" id="folder-id" value="1-WV_s3s7mLKDUfs7fl-UwH0H4TxxO1cx" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive">
                <button class="drive-btn" onclick="authAndFetchFolder()">
                    <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#FFC107" d="M17 6l11 19-11 19L6 25z"/><path fill="#1976D2" d="M17 44h22L28 25z"/><path fill="#4CAF50" d="M39 6H17l11 19z"/></svg>
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå
                </button>
            </div>
        </div>

        <div id="main-status" class="loading-box"></div>
        <div id="error-box" style="color: red; text-align: center; margin-top:10px; font-weight: bold;"></div>

        <div id="master-results-container"></div>
    </div>

    <script>
        // ‚úÖ ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google OAuth (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Drive)
        const GOOGLE_CLIENT_ID = '446093303322-5sksg8sflshmq9df4d9f72nnt3v9gcv6.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
        
        let tokenClient;
        let accessToken = null;

        // ‡πÇ‡∏´‡∏•‡∏î API Key ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        window.onload = function() {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('api-key').value = savedKey;
            }
        };

        function onGsiLoad() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    fetchFilesInFolder();
                },
            });
        }

        function authAndFetchFolder() {
            const apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Gemini API Key ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); return; }
            if (!document.getElementById('folder-id').value.trim()) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Folder ID'); return; }
            
            // ‡∏à‡∏≥ API Key ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
            localStorage.setItem('gemini_api_key', apiKey);

            if (!accessToken) tokenClient.requestAccessToken();
            else fetchFilesInFolder();
        }

        async function fetchFilesInFolder() {
            const folderId = document.getElementById('folder-id').value.trim();
            const statusBox = document.getElementById('main-status');
            const container = document.getElementById('master-results-container');
            
            container.innerHTML = ""; 
            statusBox.style.display = 'block';
            statusBox.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå... ‚è≥";

            try {
                const query = `'${folderId}' in parents and (mimeType='image/jpeg' or mimeType='image/png' or mimeType='application/pdf') and trashed=false`;
                const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,mimeType)`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                
                if (!data.files || data.files.length === 0) {
                    statusBox.innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö"; return;
                }

                statusBox.innerText = `‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå ${data.files.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î... ü§ñü©∫`;
                
                for (let i = 0; i < data.files.length; i++) {
                    await processDriveFile(data.files[i], i + 1, data.files.length);
                }
                
                statusBox.innerText = "‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß";
                statusBox.style.color = "#16a34a";
            } catch (error) {
                document.getElementById('error-box').innerText = `‚ùå Error: ${error.message}`;
            }
        }

        async function processDriveFile(fileMeta, currentIndex, totalFiles) {
            const container = document.getElementById('master-results-container');
            const fileId = fileMeta.id;
            
            const recordDiv = document.createElement('div');
            recordDiv.className = 'patient-record';
            recordDiv.id = `record-${fileId}`;
            recordDiv.innerHTML = `
                <div class="patient-header">
                    <h3>üìÑ [${currentIndex}/${totalFiles}] : ${fileMeta.name}</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span id="status-${fileId}" style="color: #2563eb; font-weight: bold; font-size: 14px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå... ü§ñ</span>
                        <button class="retry-btn" id="retry-${fileId}" onclick="retryAnalysis('${fileId}', '${fileMeta.mimeType}')">üîÑ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                </div>
                <img id="img-${fileId}" class="patient-img-preview" style="display:none;">
                <div id="results-${fileId}" class="results-grid" style="display:none;"></div>
            `;
            container.appendChild(recordDiv);

            try {
                const base64Data = await downloadFileAsBase64(fileId, fileMeta.mimeType);
                await runGeminiDetailedAnalysis(base64Data, fileMeta.mimeType, fileId);
                document.getElementById(`retry-${fileId}`).style.display = 'inline-block';
            } catch (error) {
                document.getElementById(`status-${fileId}`).innerText = `‚ùå Error: ${error.message}`;
                document.getElementById(`status-${fileId}`).style.color = "red";
                document.getElementById(`retry-${fileId}`).style.display = 'inline-block';
            }
        }

        async function downloadFileAsBase64(fileId, mimeType) {
            const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const blob = await response.blob();
            if (mimeType !== 'application/pdf') {
                const imgPreview = document.querySelector(`#img-${fileId}`);
                if (imgPreview) { imgPreview.src = URL.createObjectURL(blob); imgPreview.style.display = 'block'; }
            }
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            await new Promise(resolve => reader.onloadend = resolve);
            return reader.result.split(',')[1];
        }

        async function retryAnalysis(fileId, mimeType) {
            const statusEl = document.getElementById(`status-${fileId}`);
            const resultsGrid = document.getElementById(`results-${fileId}`);
            const retryBtn = document.getElementById(`retry-${fileId}`);
            retryBtn.disabled = true;
            statusEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ã‡πâ‡∏≥... ü§ñ";
            statusEl.style.color = "#2563eb";
            resultsGrid.style.opacity = "0.5";
            try {
                const base64Data = await downloadFileAsBase64(fileId, mimeType);
                await runGeminiDetailedAnalysis(base64Data, mimeType, fileId);
                statusEl.innerText = "‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
                statusEl.style.color = "#16a34a";
                resultsGrid.style.opacity = "1";
            } catch (error) {
                statusEl.innerText = `‚ùå Error: ${error.message}`;
                statusEl.style.color = "red";
            } finally { retryBtn.disabled = false; }
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏à‡∏±‡∏Å‡∏©‡∏∏‡πÅ‡∏û‡∏ó‡∏¢‡πå
        async function runGeminiDetailedAnalysis(base64File, mimeType, elementId) {
            const apiKey = document.getElementById('api-key').value.trim();
            const targetModel = document.getElementById('model-select').value;
            const promptText = `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: 1. ‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö DR (Normal, Mild, Moderate, Severe NPDR ‡∏´‡∏£‡∏∑‡∏≠ PDR) 2. ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≠‡∏¢‡πÇ‡∏£‡∏Ñ 3. ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á Macular Edema (CSME) 4. ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô: {"grade": "‡∏£‡∏∞‡∏î‡∏±‡∏ö", "color": "‡∏£‡∏´‡∏±‡∏™‡∏™‡∏µ", "details": "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≠‡∏¢‡πÇ‡∏£‡∏Ñ", "csme": "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á", "plan": "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"}`;
            const payload = { "contents": [{ "parts": [{ "text": promptText }, { "inline_data": { "mime_type": mimeType, "data": base64File } }] }], "generationConfig": { "response_mime_type": "application/json" } };
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${targetModel}:generateContent?key=${apiKey}`, { method: 'POST', body: JSON.stringify(payload) });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            const aiData = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json/g, "").replace(/```/g, "").trim());
            const resultsGrid = document.getElementById(`results-${elementId}`);
            resultsGrid.innerHTML = generateEyeCardHTML('‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢ (OS)', aiData.left || aiData) + generateEyeCardHTML('‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤ (OD)', aiData.right || aiData);
            resultsGrid.style.display = 'grid';
        }

        function generateEyeCardHTML(title, data) {
            return `<div class="eye-card"><h4>üëÅÔ∏è ${title} <span class="severity-badge" style="background-color: ${data.color || '#64748b'};">${data.grade || '-'}</span></h4><div class="detailed-report"><strong>üîç ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong><p>${data.details || '-'}</p></div><div class="csme-box">üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á Macular Edema: ${data.csme || '‡∏ï‡πà‡∏≥'}</div><div class="treatment-box" style="border-color: ${data.color}; color: ${data.color};">üìã ‡πÅ‡∏ú‡∏ô: ${data.plan || '-'}</div></div>`;
        }

        async function fetchModels() {
            const apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á Gemini ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            // ‡∏à‡∏≥ API Key ‡πÑ‡∏ß‡πâ
            localStorage.setItem('gemini_api_key', apiKey);
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const data = await response.json();
                const validModels = data.models.filter(m => m.name.includes("gemini"));
                const selectBox = document.getElementById('model-select');
                selectBox.innerHTML = "";
                validModels.forEach(m => { const opt = document.createElement("option"); opt.value = m.name; opt.text = m.displayName || m.name; if (m.name.includes("1.5-flash")) opt.selected = true; selectBox.appendChild(opt); });
                document.getElementById('model-selector-container').style.display = "block";
                document.getElementById('api-status').innerText = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Gemini ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
                document.getElementById('api-status').style.color = "#16a34a";
            } catch (e) { alert("API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
        }
    </script>
</body>
</html>
