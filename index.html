<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Dual-Eye Retina Analysis - Sisaket Hospital</title>
    <script async defer src="https://accounts.google.com/gsi/client" onload="onGsiLoad()"></script>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script>
    <style>
        :root { --primary: #0d9488; --os: #0369a1; --od: #b91c1c; --bg: #f1f5f9; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1300px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .setup-panel { background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e2e8f0; display: flex; gap: 15px; align-items: flex-end; }
        .input-box { flex: 1; }
        input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; margin-top: 5px; box-sizing: border-box; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        /* Layout ‡πÅ‡∏¢‡∏Å‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤ */
        .dual-eye-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px; }
        .eye-panel { border: 2px solid #e2e8f0; border-radius: 15px; padding: 20px; background: #fff; }
        .eye-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; }
        .os-title { color: var(--os); } .od-title { color: var(--od); }
        
        .ai-verify-box { background: #fff7ed; border-left: 5px solid #ea580c; padding: 12px; margin: 15px 0; font-size: 14px; border-radius: 4px; display: none; }
        canvas { width: 100%; border-radius: 8px; background: #000; border: 1px solid #cbd5e1; margin-top: 10px; }
        .file-browser { background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 20px; max-height: 150px; overflow-y: auto; display: flex; gap: 10px; flex-wrap: wrap; }
        .file-chip { padding: 5px 12px; background: white; border: 1px solid #cbd5e1; border-radius: 20px; cursor: pointer; font-size: 12px; }
        .file-chip:hover { border-color: var(--primary); color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; color:var(--primary); margin:0 0 5px 0;">üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏ï‡∏≤ (Dual-Eye Hybrid)</h1>
    <p style="text-align:center; color:#64748b; margin-bottom:25px;">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤ <strong>‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©</strong></p>

    <div class="setup-panel">
        <div class="input-box">
            <label style="font-size:12px; font-weight:bold;">üîë Gemini API Key</label>
            <input type="password" id="api-key" placeholder="Key ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ">
        </div>
        <button class="btn" style="background:#475569" onclick="authDrive()">üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Drive</button>
    </div>

    <div id="file-browser" class="file-browser">
        <div style="color:#64748b; font-size:14px; width:100%; text-align:center;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ...</div>
    </div>

    <div class="dual-eye-grid">
        <div class="eye-panel">
            <div class="eye-title os-title">üëÅÔ∏è ‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢ (OS)</div>
            <div id="os-status" style="font-size:13px; color:#64748b;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô...</div>
            <div id="os-ai" class="ai-verify-box"><strong>ü§ñ AI Verification:</strong> <span id="os-ai-text"></span></div>
            <canvas id="canvas-os-original"></canvas>
            <canvas id="canvas-os-filtered"></canvas>
        </div>

        <div class="eye-panel">
            <div class="eye-title od-title">üëÅÔ∏è ‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤ (OD)</div>
            <div id="od-status" style="font-size:13px; color:#64748b;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô...</div>
            <div id="od-ai" class="ai-verify-box"><strong>ü§ñ AI Verification:</strong> <span id="od-ai-text"></span></div>
            <canvas id="canvas-od-original"></canvas>
            <canvas id="canvas-od-filtered"></canvas>
        </div>
    </div>
</div>

<script>
    const FOLDER_ID = '1-WV_s3s7mLKDUfs7fl-UwH0H4TxxO1cx';
    let accessToken = null;

    window.onload = () => {
        const key = localStorage.getItem('sisaket_key');
        if (key) document.getElementById('api-key').value = key;
    };

    function onGsiLoad() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: '446093303322-5sksg8sflshmq9df4d9f72nnt3v9gcv6.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/drive.readonly',
            callback: (res) => { accessToken = res.access_token; fetchFileList(); }
        });
    }

    function authDrive() { 
        localStorage.setItem('sisaket_key', document.getElementById('api-key').value);
        if (!accessToken) tokenClient.requestAccessToken(); else fetchFileList(); 
    }

    async function fetchFileList() {
        const res = await fetch(`https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}' in parents and trashed=false`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await res.json();
        const browser = document.getElementById('file-browser');
        browser.innerHTML = "";
        data.files.filter(f => f.mimeType.includes('image')).forEach(f => {
            let chip = document.createElement('div');
            chip.className = 'file-chip';
            chip.innerText = f.name;
            chip.onclick = () => selectAndProcess(f.id, f.name);
            browser.appendChild(chip);
        });
    }

    async function selectAndProcess(id, name) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤
        const side = (name.toUpperCase().includes('L') || name.toUpperCase().includes('OS')) ? 'os' : 'od';
        const statusEl = document.getElementById(`${side}-status`);
        statusEl.innerText = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ${name}...`;
        
        const res = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const blob = await res.blob();
        const img = new Image();
        img.src = URL.createObjectURL(blob);
        img.onload = async () => {
            // 1. Local Screening (OpenCV)
            const ratio = runOpenCV(img, side);
            
            if (ratio < 0.04) {
                statusEl.innerHTML = `‚úÖ ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô: <strong>‡∏õ‡∏Å‡∏ï‡∏¥</strong> (Ratio: ${ratio.toFixed(3)}%)`;
                document.getElementById(`${side}-ai`).style.display = "none";
            } else {
                statusEl.innerHTML = `‚ö†Ô∏è ‡∏û‡∏ö‡∏à‡∏∏‡∏î‡∏™‡∏á‡∏™‡∏±‡∏¢ (Ratio: ${ratio.toFixed(3)}%) ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á AI ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...`;
                const base64 = await new Promise(r => { const rd = new FileReader(); rd.onloadend = () => r(rd.result.split(',')[1]); rd.readAsDataURL(blob); });
                await callGeminiVerify(base64, blob.type, side);
            }
        };
    }

    function runOpenCV(img, side) {
        let src = cv.imread(img);
        cv.imshow(`canvas-${side}-original`, src);
        let planes = new cv.MatVector(); cv.split(src, planes);
        let green = planes.get(1); // ‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å
        
        let lesions = new cv.Mat();
        let kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(7, 7));
        cv.morphologyEx(green, lesions, cv.MORPH_BLACKHAT, kernel);
        
        let binary = new cv.Mat();
        cv.threshold(lesions, binary, 25, 255, cv.THRESH_BINARY);
        cv.imshow(`canvas-${side}-filtered`, binary);
        
        let ratio = (cv.countNonZero(binary) / (binary.rows * binary.cols)) * 100;
        src.delete(); planes.delete(); green.delete(); lesions.delete(); binary.delete(); kernel.delete();
        return ratio;
    }

    async function callGeminiVerify(base64, mime, side) {
        const key = document.getElementById('api-key').value;
        const prompt = `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤‡∏ù‡∏±‡πà‡∏á ${side === 'os' ? '‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢' : '‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤'}: ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏Å‡∏£‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏≠‡∏¢‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏•‡∏°‡∏±‡πà‡∏ß‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡πÄ‡∏á‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î`;
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: mime, data: base64 } }] }] })
            });
            const data = await res.json();
            const aiText = data.candidates[0].content.parts[0].text;
            
            document.getElementById(`${side}-ai`).style.display = "block";
            document.getElementById(`${side}-ai-text`).innerText = aiText;
            document.getElementById(`${side}-status`).innerHTML += ` | ‚úÖ AI ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß`;
        } catch (e) { document.getElementById(`${side}-status`).innerText = "‚ùå ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÄ‡∏ï‡πá‡∏°?)"; }
    }

    function onOpenCvReady() { console.log("OpenCV Ready"); }
</script>
</body>
</html>
