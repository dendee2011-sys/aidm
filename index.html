<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤ (‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©)</title>
    <script async defer src="https://accounts.google.com/gsi/client" onload="onGsiLoad()"></script>
    
    <style>
        :root {
            --primary: #0f766e;
            --secondary: #0d9488;
            --drive: #1a73e8;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #334155;
            --border: #e2e8f0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 1000px;
            background: var(--card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; color: var(--primary); margin-bottom: 5px; }
        .subtitle { text-align: center; color: #64748b; margin-bottom: 30px; }
        
        .api-setup {
            background-color: #fef2f2;
            border: 1px solid #fca5a5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .api-setup input, .api-setup select {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .load-model-btn {
            margin-top: 10px;
            background-color: #475569;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

        .upload-area {
            border: 2px dashed #94a3b8;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            background-color: #f1f5f9;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        .upload-btn {
            background-color: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: inline-block;
            transition: 0.2s;
            border: none;
        }
        .upload-btn:hover { background-color: var(--secondary); }
        
        .folder-input-group {
            display: flex;
            width: 100%;
            max-width: 600px;
            gap: 10px;
            margin-top: 10px;
        }
        .folder-input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-weight: bold;
            color: #1e3a8a;
        }
        .drive-btn {
            background-color: white;
            color: var(--drive);
            border: 2px solid var(--drive);
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        .drive-btn:hover { background-color: #f0f4f9; }

        .patient-record {
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            background: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .patient-img-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: block;
            margin: 0 auto 15px auto;
        }
        
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .eye-card { border: 1px solid var(--border); border-radius: 8px; padding: 15px; background: #fafaf9; }
        .severity-badge { padding: 4px 10px; border-radius: 20px; color: white; font-size: 12px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid var(--border); }
        .treatment-box { margin-top: 15px; padding: 10px; border-radius: 6px; font-weight: bold; font-size: 13px; }

        .loading-box { display: none; text-align: center; padding: 20px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; margin-top: 20px; color: #1e3a8a; font-weight: bold; }

        @media (max-width: 768px) { .results-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>ü©∫ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô</h1>
        <div class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Google Drive (‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©)</div>

        <div class="api-setup">
            <strong>üîë 1. ‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á Gemini:</strong>
            <input type="password" id="api-key" placeholder="‡∏ß‡∏≤‡∏á Google Gemini API Key ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
            
            <button class="load-model-btn" onclick="fetchModels()">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ AI Model ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö</button>
            
            <div id="model-selector-container" style="display: none; margin-top: 15px;">
                <strong>ü§ñ 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å AI Model:</strong>
                <select id="model-select"></select>
            </div>
            <div id="api-status" style="margin-top: 10px; font-size: 14px; font-weight: bold;"></div>
        </div>

        <div class="upload-area">
            <p style="margin-bottom: 0; color: #1a73e8; font-weight: bold;">üìÅ ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å</p>
            <div class="folder-input-group">
                <input type="text" id="folder-id" value="1-WV_s3s7mLKDUfs7fl-UwH0H4TxxO1cx" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive">
                <button class="drive-btn" onclick="authAndFetchFolder()">
                    <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#FFC107" d="M17 6l11 19-11 19L6 25z"/><path fill="#1976D2" d="M17 44h22L28 25z"/><path fill="#4CAF50" d="M39 6H17l11 19z"/></svg>
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå
                </button>
            </div>
            <p style="font-size: 12px; color: #64748b;">(‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</p>
        </div>

        <div id="main-status" class="loading-box"></div>
        <div id="error-box" style="color: red; text-align: center; margin-top:10px; font-weight: bold;"></div>

        <div id="master-results-container"></div>
    </div>

    <script>
        const GOOGLE_CLIENT_ID = '446093303322-5sksg8sflshmq9df4d9f72nnt3v9gcv6.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
        
        let tokenClient;
        let accessToken = null;

        function onGsiLoad() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    fetchFilesInFolder();
                },
            });
        }

        function authAndFetchFolder() {
            if (!document.getElementById('folder-id').value.trim()) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Folder ID'); return;
            }
            if (!document.getElementById('api-key').value.trim() || !document.getElementById('model-select').value) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î AI Model ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); return;
            }
            if (!accessToken) tokenClient.requestAccessToken();
            else fetchFilesInFolder();
        }

        async function fetchFilesInFolder() {
            const folderId = document.getElementById('folder-id').value.trim();
            const statusBox = document.getElementById('main-status');
            const container = document.getElementById('master-results-container');
            
            container.innerHTML = ""; 
            statusBox.style.display = 'block';
            statusBox.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û... ‚è≥";

            try {
                const query = `'${folderId}' in parents and (mimeType='image/jpeg' or mimeType='image/png' or mimeType='application/pdf') and trashed=false`;
                const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,mimeType)`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                
                if (!data.files || data.files.length === 0) {
                    statusBox.innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö"; return;
                }

                statusBox.innerText = `‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå ${data.files.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£... ü§ñ`;
                
                for (let i = 0; i < data.files.length; i++) {
                    await processDriveFile(data.files[i], i + 1, data.files.length);
                }
                
                statusBox.innerText = "‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß";
                statusBox.style.color = "#16a34a";
            } catch (error) {
                document.getElementById('error-box').innerText = `‚ùå Error: ${error.message}`;
            }
        }

        async function processDriveFile(fileMeta, currentIndex, totalFiles) {
            const container = document.getElementById('master-results-container');
            const fileId = fileMeta.id;
            
            const recordDiv = document.createElement('div');
            recordDiv.className = 'patient-record';
            recordDiv.innerHTML = `
                <div class="patient-header">
                    <h3>üìÑ [${currentIndex}/${totalFiles}] : ${fileMeta.name}</h3>
                    <span id="status-${fileId}" style="color: #2563eb; font-weight: bold;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå... ü§ñ</span>
                </div>
                <img id="img-${fileId}" class="patient-img-preview" style="display:none;">
                <div id="results-${fileId}" class="results-grid" style="display:none;"></div>
            `;
            container.appendChild(recordDiv);

            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const blob = await response.blob();
                
                const imgEl = document.getElementById(`img-${fileId}`);
                if (fileMeta.mimeType !== 'application/pdf') {
                    imgEl.src = URL.createObjectURL(blob);
                    imgEl.style.display = 'block';
                }

                const reader = new FileReader();
                reader.readAsDataURL(blob);
                await new Promise(resolve => reader.onloadend = resolve);
                const base64File = reader.result.split(',')[1];

                await runGeminiAnalysis(base64File, fileMeta.mimeType, fileId);
            } catch (error) {
                document.getElementById(`status-${fileId}`).innerText = `‚ùå Error: ${error.message}`;
            }
        }

        async function runGeminiAnalysis(base64File, mimeType, elementId) {
            const apiKey = document.getElementById('api-key').value.trim();
            const targetModel = document.getElementById('model-select').value;

            const promptText = `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤‡∏ô‡∏µ‡πâ (Diabetic Retinopathy) ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON: {"left": {"grade": "‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢", "color": "#‡∏£‡∏´‡∏±‡∏™‡∏™‡∏µ", "ma": "‡∏û‡∏ö/‡πÑ‡∏°‡πà‡∏û‡∏ö", "hm": "‡∏û‡∏ö/‡πÑ‡∏°‡πà‡∏û‡∏ö", "he": "‡∏û‡∏ö/‡πÑ‡∏°‡πà‡∏û‡∏ö", "treatment": "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"}, "right": {"grade": "‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤", "color": "#‡∏£‡∏´‡∏±‡∏™‡∏™‡∏µ", "ma": "‡∏û‡∏ö/‡πÑ‡∏°‡πà‡∏û‡∏ö", "hm": "‡∏û‡∏ö/‡πÑ‡∏°‡πà‡∏û‡∏ö", "he": "‡∏û‡∏ö/‡πÑ‡∏°‡πà‡∏û‡∏ö", "treatment": "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"}}`;
            
            const payload = { "contents": [{ "parts": [{ "text": promptText }, { "inline_data": { "mime_type": mimeType, "data": base64File } }] }], "generationConfig": { "response_mime_type": "application/json" } };
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${targetModel}:generateContent?key=${apiKey}`, { method: 'POST', body: JSON.stringify(payload) });
            const data = await response.json();
            
            let resultText = data.candidates[0].content.parts[0].text.replace(/```json/g, "").replace(/```/g, "").trim();
            const aiData = JSON.parse(resultText);
            
            const resultsGrid = document.getElementById(`results-${elementId}`);
            resultsGrid.innerHTML = generateEyeCardHTML('‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢', aiData.left) + generateEyeCardHTML('‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤', aiData.right);
            resultsGrid.style.display = 'grid';
            document.getElementById(`status-${elementId}`).innerText = "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
        }

        function generateEyeCardHTML(title, data) {
            return `<div class="eye-card">
                <h4>üëÅÔ∏è ${title} <span class="severity-badge" style="background-color: ${data.color};">${data.grade}</span></h4>
                <table>
                    <tr><th>Microaneurysms</th><td>${data.ma}</td></tr>
                    <tr><th>Hemorrhages</th><td>${data.hm}</td></tr>
                    <tr><th>Hard Exudates</th><td>${data.he}</td></tr>
                </table>
                <div class="treatment-box" style="border: 1px solid ${data.color}; color: ${data.color};">${data.treatment}</div>
            </div>`;
        }

        async function fetchModels() {
            const apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) return alert("‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const data = await response.json();
                const validModels = data.models.filter(m => m.name.includes("gemini"));
                const selectBox = document.getElementById('model-select');
                selectBox.innerHTML = "";
                validModels.forEach(m => {
                    const opt = document.createElement("option"); opt.value = m.name; opt.text = m.name;
                    if (m.name.includes("flash")) opt.selected = true;
                    selectBox.appendChild(opt);
                });
                document.getElementById('model-selector-container').style.display = "block";
                document.getElementById('api-status').innerText = "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Gemini ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
            } catch (e) { alert("API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
        }
    </script>
</body>
</html>
