<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Hybrid Retina AI - Sisaket Hospital</title>
    <script async defer src="https://accounts.google.com/gsi/client" onload="onGsiLoad()"></script>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script>
    <style>
        :root { --primary: #0d9488; --bg: #f1f5f9; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .setup-panel { background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e2e8f0; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; margin: 10px 0; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .patient-grid { display: grid; grid-template-columns: 300px 1fr; gap: 20px; margin-top: 20px; }
        .status-badge { padding: 5px 12px; border-radius: 15px; font-size: 12px; color: white; font-weight: bold; }
        .report-box { border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; }
        canvas { width: 100%; border-radius: 8px; background: #000; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; color:var(--primary);">ü©∫ Hybrid Retina Screening (Sisaket v3)</h1>
    
    <div class="setup-panel">
        <label>üîë ‡πÉ‡∏™‡πà Gemini API Key (‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏™‡∏á‡∏™‡∏±‡∏¢)</label>
        <input type="password" id="api-key" placeholder="API Key ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ">
        <button class="btn" style="background:#475569" onclick="authDrive()">üìÇ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå ‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©</button>
    </div>

    <div class="patient-grid">
        <div style="background:#f1f5f9; padding:15px; border-radius:10px;">
            <strong>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</strong>
            <div id="file-list" style="margin-top:10px; max-height:500px; overflow-y:auto;"></div>
        </div>

        <div id="result-area" style="display:none;">
            <div class="report-box">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 id="p-name" style="margin:0;">-</h2>
                    <div id="grade-badge" class="status-badge">‡∏£‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£...</div>
                </div>
                
                <div id="ai-insight" style="background:#fff7ed; padding:15px; border-radius:8px; border-left:5px solid #ea580c; margin-bottom:20px; display:none;">
                    <strong>ü§ñ AI Verification:</strong> <span id="ai-text"></span>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div><canvas id="canvas-original"></canvas><center><small>‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</small></center></div>
                    <div><canvas id="canvas-filtered"></canvas><center><small>‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà OpenCV ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö</small></center></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const FOLDER_ID = '1-WV_s3s7mLKDUfs7fl-UwH0H4TxxO1cx';
    let accessToken = null;

    window.onload = () => {
        const key = localStorage.getItem('sisaket_key');
        if (key) document.getElementById('api-key').value = key;
    };

    function onGsiLoad() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: '446093303322-5sksg8sflshmq9df4d9f72nnt3v9gcv6.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/drive.readonly',
            callback: (res) => { accessToken = res.access_token; fetchFiles(); }
        });
    }

    function authDrive() { 
        localStorage.setItem('sisaket_key', document.getElementById('api-key').value);
        tokenClient.requestAccessToken(); 
    }

    async function fetchFiles() {
        const res = await fetch(`https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}' in parents and trashed=false`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await res.json();
        const list = document.getElementById('file-list');
        list.innerHTML = "";
        data.files.filter(f => f.mimeType.includes('image')).forEach(f => {
            let d = document.createElement('div');
            d.style = "padding:8px; border-bottom:1px solid #cbd5e1; cursor:pointer; font-size:13px;";
            d.innerText = f.name;
            d.onclick = () => processHybrid(f.id, f.name);
            list.appendChild(d);
        });
    }

    async function processHybrid(id, name) {
        document.getElementById('result-area').style.display = "block";
        document.getElementById('p-name').innerText = name;
        document.getElementById('ai-insight').style.display = "none";
        
        const res = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const blob = await res.blob();
        const img = new Image();
        img.src = URL.createObjectURL(blob);
        img.onload = async () => {
            // --- Step 1: Local OpenCV Screening ---
            const ratio = runOpenCV(img);
            
            if (ratio < 0.04) { // ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                updateUI("Normal (‡∏õ‡∏Å‡∏ï‡∏¥)", "#16a34a", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≠‡∏¢‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            } else { // ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏à‡∏∏‡∏î‡∏™‡∏á‡∏™‡∏±‡∏¢ ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ Gemini ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                updateUI("Checking with AI...", "#ca8a04", "‡∏û‡∏ö‡∏à‡∏∏‡∏î‡∏™‡∏á‡∏™‡∏±‡∏¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏£‡∏≠‡∏á‡∏ú‡∏•‡∏ö‡∏ß‡∏Å‡∏õ‡∏•‡∏≠‡∏°... ü§ñ");
                const base64 = await new Promise(r => { const rd = new FileReader(); rd.onloadend = () => r(rd.result.split(',')[1]); rd.readAsDataURL(blob); });
                await callGeminiVerify(base64, blob.type);
            }
        };
    }

    function runOpenCV(img) {
        let src = cv.imread(img);
        cv.imshow('canvas-original', src);
        let planes = new cv.MatVector();
        cv.split(src, planes);
        let green = planes.get(1); // ‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
        
        let lesions = new cv.Mat();
        let kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(7, 7));
        cv.morphologyEx(green, lesions, cv.MORPH_BLACKHAT, kernel);
        
        let binary = new cv.Mat();
        cv.threshold(lesions, binary, 25, 255, cv.THRESH_BINARY);
        cv.imshow('canvas-filtered', binary);
        
        let ratio = (cv.countNonZero(binary) / (binary.rows * binary.cols)) * 100;
        src.delete(); planes.delete(); green.delete(); lesions.delete(); binary.delete(); kernel.delete();
        return ratio;
    }

    async function callGeminiVerify(base64, mime) {
        const key = document.getElementById('api-key').value;
        const prompt = "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ: ‡∏°‡∏µ Hemorrhage ‡∏´‡∏£‡∏∑‡∏≠ Microaneurysm ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î/‡πÄ‡∏á‡∏≤? ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÅ‡∏•‡∏∞‡∏ö‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á";
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: mime, data: base64 } }] }] })
            });
            const data = await res.json();
            const aiText = data.candidates[0].content.parts[0].text;
            
            document.getElementById('ai-insight').style.display = "block";
            document.getElementById('ai-text').innerText = aiText;
            updateUI("AI Verified", "#0ea5e9", "AI ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
        } catch (e) { updateUI("Error", "#dc2626", "‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏´‡∏£‡∏∑‡∏≠ Key ‡∏Ñ‡∏£‡∏±‡∏ö"); }
    }

    function updateUI(status, color, plan) {
        const badge = document.getElementById('grade-badge');
        badge.innerText = status;
        badge.style.background = color;
    }
</script>
</body>
</html>
